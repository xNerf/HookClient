package ru.levin.modules.player;

import com.google.gson.*;
import net.minecraft.client.gui.screen.ingame.GenericContainerScreen;
import net.minecraft.item.Item;
import net.minecraft.item.ItemStack;
import net.minecraft.network.packet.s2c.play.InventoryS2CPacket;
import net.minecraft.registry.Registries;
import net.minecraft.util.Identifier;
import org.joml.Vector4f;
import ru.levin.ExosWare;
import ru.levin.events.Event;
import ru.levin.events.impl.EventPacket;
import ru.levin.events.impl.EventUpdate;
import ru.levin.events.impl.player.EventAttack;
import ru.levin.events.impl.render.EventRender2D;
import ru.levin.manager.ClientManager;
import ru.levin.manager.dragManager.Dragging;
import ru.levin.modules.Function;
import ru.levin.modules.FunctionAnnotation;
import ru.levin.modules.Type;
import ru.levin.modules.setting.BooleanSetting;
import ru.levin.modules.setting.ModeSetting;
import ru.levin.manager.fontManager.FontUtils;
import ru.levin.util.player.TimerUtil;

import java.awt.*;
import java.io.*;
import java.util.ArrayList;
import java.util.List;

import static ru.levin.util.color.ColorUtil.hud_color;
import static ru.levin.util.render.RenderUtil.drawRoundedRect;

@FunctionAnnotation(name = "InvseeExploit", type = Type.Player, desc = "Sender/Receiver mode invsee exploit")
public class InvseeExploit extends Function {
    private final ModeSetting mode = new ModeSetting("Mode", "Отправляющий", "Отправляющий", "Получающий");

    private final BooleanSetting debug = new BooleanSetting("Debug",false);
    public final File configDir = new File(mc.runDirectory, "files/modules");
    private final File targetFile = new File(configDir,"InvseeExploitName.ew");
    private final File invFile = new File(configDir,"InvseeExploitItems.ew");


    private final Gson gson = new GsonBuilder().setPrettyPrinting().create();

    private final List<ItemStack> invseeItems = new ArrayList<>();

    private final TimerUtil timerUtil = new TimerUtil();

    public Dragging targetInventory = ExosWare.getInstance().createDrag(this, "InventoryHUD", 800, 200);

    public InvseeExploit() {
        addSettings(mode,debug);
    }

    @Override
    public void onEvent(Event event) {
        if (event instanceof EventAttack eventAttack && mode.is("Отправляющий")) {
            try (FileWriter writer = new FileWriter(targetFile)) {
                JsonObject obj = new JsonObject();
                obj.addProperty("target", eventAttack.getTarget().getName().getString());
                gson.toJson(obj, writer);
                if (debug.get()) {
                    ClientManager.message("Получен таргет - " + eventAttack.getTarget().getName().getString());
                }
            } catch (Exception e) {
                e.printStackTrace();
            }

        }

        if (event instanceof EventRender2D eventRender2D && mode.is("Отправляющий")) {
            float x = targetInventory.getX();
            float y = targetInventory.getY();
            float slotSize = 16.0F;
            int columns = 9;
            int rows = 4;

            float totalWidth = slotSize * columns;
            float totalHeight = slotSize * rows;

            float headerHeight = 18.0F;
            float spacing = 3.0F;

            drawRoundedRect(eventRender2D.getMatrixStack(), x, y, totalWidth + 4, headerHeight, new Vector4f(4,0,0,4), hud_color);

            drawRoundedRect(eventRender2D.getMatrixStack(), x, y + headerHeight - 2, totalWidth + 4, totalHeight + 6, new Vector4f(0,4,4,0), new Color(22,22,22, 130).getRGB());

            FontUtils.durman[15].centeredDraw(eventRender2D.getMatrixStack(), "Инвентарь противника", x + (totalWidth + 4) / 2F, y + headerHeight / 2F - 5, -1);

            while (invseeItems.size() < 46) {
                invseeItems.add(ItemStack.EMPTY);
            }

            int slotIndex = 9;
            for (int row = 0; row < rows; row++) {
                for (int col = 0; col < columns; col++) {
                    float slotX = x + 2 + col * slotSize;
                    float slotY = y + headerHeight + spacing + row * slotSize;

                    ItemStack stack;
                    if (row < 3) {
                        stack = invseeItems.get(slotIndex);
                        slotIndex++;
                    } else {
                        stack = invseeItems.get(col);
                    }

                    if (!stack.isEmpty()) {
                        eventRender2D.getDrawContext().getMatrices().push();
                        eventRender2D.getDrawContext().getMatrices().translate(slotX, slotY, 0);
                        eventRender2D.getMatrixStack().scale(0.92f, 0.92f, 1);
                        eventRender2D.getDrawContext().drawItem(stack, 0, 0);
                        eventRender2D.getDrawContext().drawStackOverlay(mc.textRenderer, stack, 0, 0);
                        eventRender2D.getDrawContext().getMatrices().pop();
                    }
                }
            }
            targetInventory.setWidth((int) (totalWidth + 4));
            targetInventory.setHeight((int) (totalHeight + headerHeight + spacing));
        }

        if (event instanceof EventUpdate) {
            if (mode.is("Получающий")) {
                if (timerUtil.hasTimeElapsed(2000)) {
                    try (FileReader reader = new FileReader(targetFile)) {
                        JsonObject obj = gson.fromJson(reader, JsonObject.class);
                        String targetName = obj.get("target").getAsString();
                        mc.player.networkHandler.sendCommand("invsee " + targetName);
                        timerUtil.reset();
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            } else if (mode.is("Отправляющий")) {
                try (FileReader reader = new FileReader(invFile)) {
                    JsonArray array = gson.fromJson(reader, JsonArray.class);
                    invseeItems.clear();
                    for (JsonElement element : array) {
                        JsonObject obj = element.getAsJsonObject();
                        Identifier id = Identifier.tryParse(obj.get("id").getAsString());
                        if (id != null && Registries.ITEM.containsId(id)) {
                            Item item = Registries.ITEM.get(id);
                            ItemStack stack = new ItemStack(item, obj.get("count").getAsInt());
                            invseeItems.add(stack);
                        }
                    }
                } catch (Exception ignored) {
                }
            }
        }

        if (event instanceof EventPacket packetEvent && packetEvent.getPacket() instanceof InventoryS2CPacket packet && mode.is("Получающий")) {
            try {
                String targetName;
                try (FileReader reader = new FileReader(targetFile)) {
                    JsonObject obj = gson.fromJson(reader, JsonObject.class);
                    targetName = obj.get("target").getAsString();
                }
                if (mc.player == null || mc.player.getName().getString().equalsIgnoreCase(targetName) || mc.player.currentScreenHandler == null || !(mc.currentScreen instanceof GenericContainerScreen)) {
                    return;
                }

                invseeItems.clear();

                int limit = Math.min(36, packet.getContents().size());
                for (int i = 0; i < limit; i++) {
                    ItemStack stack = packet.getContents().get(i);
                    invseeItems.add(stack.isEmpty() ? ItemStack.EMPTY : stack.copy());
                }

                while (invseeItems.size() < 36) {
                    invseeItems.add(ItemStack.EMPTY);
                }

                try (FileWriter writer = new FileWriter(invFile)) {
                    JsonArray array = new JsonArray();
                    for (ItemStack stack : invseeItems) {
                        JsonObject stackObj = new JsonObject();
                        Identifier id = Registries.ITEM.getId(stack.getItem());
                        stackObj.addProperty("id", id.toString());
                        stackObj.addProperty("count", stack.getCount());
                        array.add(stackObj);
                    }
                    gson.toJson(array, writer);
                }

            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    @Override
    public void onDisable() {
        invseeItems.clear();
    }
}
