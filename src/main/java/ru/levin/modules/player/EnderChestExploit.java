package ru.levin.modules.player;

import net.minecraft.item.ItemStack;
import net.minecraft.screen.GenericContainerScreenHandler;
import net.minecraft.screen.ScreenHandler;
import net.minecraft.screen.slot.SlotActionType;
import ru.levin.events.Event;
import ru.levin.events.impl.input.EventKey;
import ru.levin.events.impl.EventUpdate;
import ru.levin.modules.Function;
import ru.levin.modules.FunctionAnnotation;
import ru.levin.modules.Type;
import ru.levin.modules.setting.BindSetting;

@SuppressWarnings("All")
@FunctionAnnotation(name = "EnderChestExploit", desc = "", type = Type.Player)
public class EnderChestExploit extends Function {

    private final BindSetting bind = new BindSetting("Кнопка сейва", -1);
    private boolean check = false;
    private boolean fakeClosed = false;

    private GenericContainerScreenHandler savedHandler = null;

    public EnderChestExploit() {
        addSettings(bind);
    }

    @Override
    public void onEvent(Event event) {
        if (event instanceof EventKey eventKey) {
            if (eventKey.key == bind.getKey()) {
                check = true;
            }
        }

        if (event instanceof EventUpdate) {
            ScreenHandler handler = mc.player.currentScreenHandler;
            if (handler != null && handler.slots.size() >= 27 && handler.getStacks().size() <= 63) {
                int chestSlots = handler.slots.size() - 36;
                if (chestSlots == 27) {
                    if (!fakeClosed && mc.currentScreen != null) {
                        mc.currentScreen = null;
                        mc.mouse.lockCursor();
                        fakeClosed = true;
                    }
                    if (check) {
                        check = false;
                        fakeClosed = false;

                        for (int i = chestSlots; i < handler.slots.size(); i++) {
                            ItemStack stack = handler.getSlot(i).getStack();
                            if (!stack.isEmpty()) {
                                mc.interactionManager.clickSlot(handler.syncId, i, 0, SlotActionType.QUICK_MOVE, mc.player);
                            }
                        }
                    }
                }
            } else {
                fakeClosed = false;
            }
        }
    }

    @Override
    public void onDisable() {
        check = false;
        fakeClosed = false;
        savedHandler = null;
    }
}
