package ru.levin.modules.player;

import com.google.gson.*;
import net.minecraft.network.packet.s2c.play.GameMessageS2CPacket;
import net.minecraft.text.Text;
import net.minecraft.util.Formatting;
import ru.levin.modules.setting.BindSetting;
import ru.levin.modules.setting.BooleanSetting;
import ru.levin.modules.setting.ModeSetting;
import ru.levin.modules.setting.SliderSetting;
import ru.levin.events.Event;
import ru.levin.events.impl.input.EventKey;
import ru.levin.events.impl.EventPacket;
import ru.levin.manager.ClientManager;
import ru.levin.manager.Manager;
import ru.levin.modules.Function;
import ru.levin.modules.FunctionAnnotation;
import ru.levin.modules.Type;

import java.io.*;
import java.nio.channels.FileChannel;
import java.nio.channels.FileLock;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.ThreadLocalRandom;
import java.util.concurrent.TimeUnit;

@FunctionAnnotation(name = "RegionExploit" ,desc  = "", type = Type.Player)
public class RegionExploit extends Function {
    private final ModeSetting minecraft = new ModeSetting("Тип", "Отправляющий", "Отправляющий", "Получающий");
    private final BindSetting sendKey = new BindSetting("Кнопка отправки",0,() -> minecraft.getIndex() == 0);
    private final SliderSetting radius = new SliderSetting("Радиус", 10, 1, 50, 1,() -> minecraft.getIndex() == 0);
    private final BooleanSetting removeOldRegion = new BooleanSetting("Удалять старый рг", true,() -> minecraft.getIndex() == 0);
    private final BooleanSetting addNearbyFriends = new BooleanSetting("Добавлять друзей", true,() -> minecraft.getIndex() == 0);

    private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    private long lastModified = 0;
    private String lastRegionName = null;
    private boolean shouldRemovePreviousRegion = false;


    private final Gson gson = new GsonBuilder().setPrettyPrinting().create();
    public final File configDir = new File(mc.runDirectory, "files\\modules");

    public RegionExploit() {
        addSettings(minecraft,sendKey,radius,removeOldRegion,addNearbyFriends);
    }
    @Override
    public void onEvent(Event event) {
        File coordinatesFile = getCoordinatesFile();

        if (minecraft.getIndex() == 0) {
            if (event instanceof EventKey eventKey && eventKey.key == sendKey.getKey()) {
                ClientManager.message(Formatting.GREEN + "Запрос отправлен");
                saveData();
            }

            if (coordinatesFile.exists()) {
                try (FileReader reader = new FileReader(coordinatesFile)) {
                    JsonObject jsonObject = JsonParser.parseReader(reader).getAsJsonObject();

                    if (jsonObject.has("created") && jsonObject.get("created").getAsBoolean()) {
                        ClientManager.message(Formatting.GREEN + "Регион успешно создан!");
                        jsonObject.remove("created");
                    }

                    if (jsonObject.has("overlaps") && jsonObject.get("overlaps").getAsBoolean()) {
                        ClientManager.message(Formatting.RED + "Не удалось создать регион, рядом чужой регион");
                        jsonObject.remove("overlaps");
                    }

                    try (FileWriter fileWriter = new FileWriter(getCoordinatesFile())) {
                        gson.toJson(jsonObject, fileWriter);
                    } catch (IOException ignored) {}

                } catch (Exception ignored) {}
            }
        }

        if (minecraft.getIndex() == 1) {
            if (coordinatesFile.exists() && coordinatesFile.lastModified() > lastModified) {
                processData();
                lastModified = coordinatesFile.lastModified();
            }

            if (event instanceof EventPacket eventPacket) {
                if (eventPacket.getPacket() instanceof GameMessageS2CPacket clientboundSystemChatPacket) {
                    Text message = clientboundSystemChatPacket.content();
                    if (message.getString().contains("Вы заприватили регион" + " " + lastRegionName)) {
                        shouldRemovePreviousRegion = true;
                        try (FileWriter fileWriter = new FileWriter(getCoordinatesFile())) {
                            JsonObject json = new JsonObject();
                            json.addProperty("created", true);
                            gson.toJson(json, fileWriter);
                        } catch (IOException ignored) {}
                    }

                    if (message.getString().contains("Это регион перекрывает чужой регион")) {
                        try (FileWriter fileWriter = new FileWriter(getCoordinatesFile())) {
                            JsonObject json = new JsonObject();
                            json.addProperty("overlaps", true);
                            gson.toJson(json, fileWriter);
                        } catch (IOException ignored) {}
                    }
                }
            }
        }
    }
    private void saveData() {
        File coordinatesFile = getCoordinatesFile();
        try (FileWriter fileWriter = new FileWriter(coordinatesFile)) {
            JsonObject jsonObject = new JsonObject();
            jsonObject.addProperty("x", (int) mc.player.getX());
            jsonObject.addProperty("y", (int) mc.player.getY());
            jsonObject.addProperty("z", (int) mc.player.getZ());
            jsonObject.addProperty("radius", radius.get().floatValue());
            jsonObject.addProperty("sender", mc.player.getName().getString());
            jsonObject.addProperty("removeOld", removeOldRegion.get());

            if (addNearbyFriends.get()) {
                JsonArray nearbyFriends = new JsonArray();
                for (var player : Manager.SYNC_MANAGER.getPlayers()) {
                    if (player == mc.player) {
                        continue;
                    }

                    String name = player.getName().getString();
                    if (Manager.FRIEND_MANAGER.isFriend(name)) {
                        nearbyFriends.add(name);
                    }
                }

                jsonObject.add("friends", nearbyFriends);
            }

            gson.toJson(jsonObject, fileWriter);
        } catch (IOException ignored) {}

        coordinatesFile.setLastModified(System.currentTimeMillis());
    }

    private void processData() {
        File coordinatesFile = getCoordinatesFile();
        try (RandomAccessFile randomAccessFile = new RandomAccessFile(coordinatesFile, "rw");
             FileChannel fileChannel = randomAccessFile.getChannel();
             FileLock fileLock = fileChannel.tryLock()) {
            if (fileLock != null) {
                randomAccessFile.seek(0);
                byte[] bytes = new byte[(int) randomAccessFile.length()];
                randomAccessFile.readFully(bytes);
                String content = new String(bytes);
                JsonObject jsonObject = JsonParser.parseString(content).getAsJsonObject();
                if (jsonObject != null) {
                    double x = jsonObject.get("x").getAsDouble();
                    double y = jsonObject.get("y").getAsDouble();
                    double z = jsonObject.get("z").getAsDouble();
                    int radius = jsonObject.get("radius").getAsInt();

                    String previousRegionName = lastRegionName;
                    int delayOffset = (shouldRemovePreviousRegion && previousRegionName != null && jsonObject.has("removeOld") && jsonObject.get("removeOld").getAsBoolean()) ? 1 : 0;

                    if (shouldRemovePreviousRegion && previousRegionName != null && jsonObject.has("removeOld") && jsonObject.get("removeOld").getAsBoolean()) {
                        mc.player.networkHandler.sendCommand("region remove " + previousRegionName);
                        shouldRemovePreviousRegion = false;
                    }

                    String regionName = "region_" + String.format("%05d", ThreadLocalRandom.current().nextInt(0, 100000));
                    lastRegionName = regionName;

                    double x1 = x - radius;
                    double x2 = x + radius;
                    double z1 = z - radius;
                    double z2 = z + radius;

                    scheduler.schedule(() -> mc.player.networkHandler.sendCommand("/1" + " " + x1 + "," + y + "," + z1), delayOffset, TimeUnit.SECONDS);
                    scheduler.schedule(() -> mc.player.networkHandler.sendCommand("/2" + " " + x2 + "," + y + "," + z2), delayOffset + 1, TimeUnit.SECONDS);
                    scheduler.schedule(() -> mc.player.networkHandler.sendCommand("/expand" + " " + radius + " down"), delayOffset + 2, TimeUnit.SECONDS);
                    scheduler.schedule(() -> mc.player.networkHandler.sendCommand("/expand" + " " + radius + " up"), delayOffset + 3, TimeUnit.SECONDS);
                    scheduler.schedule(() -> mc.player.networkHandler.sendCommand("region claim" + " " + regionName), delayOffset + 4, TimeUnit.SECONDS);
                    scheduler.schedule(() -> mc.player.networkHandler.sendCommand("region addmember" + " " + regionName + " " + jsonObject.get("sender").getAsString()), delayOffset + 5, TimeUnit.SECONDS);
                    if (jsonObject.has("friends") && jsonObject.get("friends").isJsonArray()) {
                        JsonArray friends = jsonObject.getAsJsonArray("friends");
                        int friendDelay = delayOffset + 6;

                        for (JsonElement element : friends) {
                            String friendName = element.getAsString();
                            if (!friendName.equals(mc.player.getName().getString())) {
                                scheduler.schedule(() -> mc.player.networkHandler.sendCommand("region addmember " + regionName + " " + friendName), friendDelay, TimeUnit.SECONDS);
                            }

                            friendDelay++;
                        }
                    }

                    try {
                        new FileWriter(getCoordinatesFile(), false).close();
                    } catch (IOException ignored) {}
                }
            }
        } catch (Exception ignored) {}
    }

    private File getCoordinatesFile() {
        return new File(configDir, "RegionExploitInfo.json");
    }

    @Override
    public void onEnable() {
        if (minecraft.getIndex() == 1) {
            File coordinatesFile = getCoordinatesFile();
            if (coordinatesFile.exists()) {
                lastModified = coordinatesFile.lastModified();
            }
        }
    }
}